<!doctype html> <html> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1"> <title>DESCEND - Quick Prototypes with client-side web scraping</title> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/posts/feed.xml"/> <link href="../../../../stylesheets/main-f00d81e5.css" rel=stylesheet /> <link href="../../../../stylesheets/syntax-79b5cf2b.css" rel=stylesheet /> <link href='http://fonts.googleapis.com/css?family=Roboto+Slab:400' rel=stylesheet> </head> <body> <article class=blog> <h1><a href='/'>DESCEND</a></h1> <h2>Quick Prototypes with client-side web scraping</h2> <p>Setting the line-in-the-sand of a minimum viable product can be an art. If you&rsquo;re building apps that require external data, there&rsquo;s almost no end to the amount of technical foundation you <em>could</em> lay before you even start building an interface. API clients, crawlers, scrapers, databases, queues, caches, even more queues with fail modes and staggered retries&hellip;</p> <p>In an app that&rsquo;s expected to scale or perform any long-term analysis on stored data, your data harvesting needs to be reliable, idempotent, and repeatable. But for building an MVP, all of this can be overkill. Sometimes all you need is some basic jQuery.</p> <h3>Move quick and leverage the hard work of others</h3> <p>In this example, I&rsquo;m pulling data from a site that lists upcoming soccer matches. The data is listed in tables sorted by time. We want to grab things like team names, their logos, match times, and URLs so we can link back to the original page.</p> <p>To start we want to create a <code>Match</code> object. This will hold individual match data and necessary functions for fetching and displaying information.</p> <pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">Match</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// setup initial properties</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">homeName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">awayName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">matchTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>

  <span class="c1">// kick off any functions you want called on object creation</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="p">};</span>
</code></pre> <p>In this case, our initialize function is simple. Go fetch extra information and then render it as a row in a table.</p> <pre class="highlight javascript"><code><span class="nx">Match</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// get the thing</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">();</span>

  <span class="c1">// display the thing</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">render</span><span class="p">();</span>
<span class="p">}};</span>
</code></pre> <p>Our data source has a sub-page for each row in the table where extra information is kept. So our <code>Match</code> object will have it&rsquo;s own <code>fetch</code> method to grab the sub-page and parse all the relevant metadata.</p> <pre class="highlight javascript"><code><span class="nx">Match</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">fetch</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
    <span class="na">url</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
    <span class="na">success</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">html</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>

      <span class="c1">// parse the info you are looking for. we'll grab team logos here</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">homeImage</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">html</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.homeLogo img'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'src'</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">awayImage</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">html</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.awayLogo img'</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">'src'</span><span class="p">);</span>

      <span class="c1">// ... and on, and on for other data you need</span>
    <span class="p">};</span>
  <span class="p">});</span>
<span class="p">};</span>
</code></pre> <p>Instead of creating a whole separate view layer to handle display logic, we can just tack on render function to get everything displayed quickly.</p> <pre class="highlight javascript"><code><span class="nx">Match</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// initialize the container object if it's the first render</span>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">===</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">el</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">'&lt;tr&gt;&lt;/tr&gt;'</span><span class="p">).</span><span class="nx">appendTo</span><span class="p">(</span><span class="s1">'#matches tbody'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// display whatever relevant match information</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="s1">'&lt;td&gt;'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">homeTeam</span> <span class="o">+</span> <span class="s1">'&lt;/td&gt;&lt;td&gt;'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">awayTeam</span> <span class="o">+</span> <span class="s1">'&lt;/td&gt;'</span><span class="p">);</span>
<span class="p">};</span>
</code></pre> <p>Now we just need to scrape the initial page, create new match objects, and render them to the page.</p> <pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">parseMatchLinks</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// loop through each match row</span>
  <span class="nx">$</span><span class="p">(</span><span class="nx">html</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.match'</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// parse relevant match information</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">homeTeam</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.homeName'</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">awayTeam</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.awayName'</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">matchDateTime</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">html</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.matchTime'</span><span class="p">).</span><span class="nx">text</span><span class="p">().</span><span class="nx">trim</span><span class="p">();</span>

    <span class="c1">// create our match object. from our code above, the Match object will parse it's sub-page and display itself when it's ready</span>
    <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Match</span><span class="p">({</span> <span class="na">url</span><span class="p">:</span> <span class="nx">url</span><span class="p">,</span> <span class="na">title</span><span class="p">:</span> <span class="nx">title</span><span class="p">,</span> <span class="na">otherData</span><span class="p">:</span> <span class="nx">otherData</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
  <span class="c1">// fetch then parse</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span> <span class="na">url</span><span class="p">:</span> <span class="s1">'http://target_site_url'</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="nx">parseMatchLinks</span><span class="p">);</span>
<span class="p">});</span>
</code></pre> <p>Done! Right? Not quite.</p> <h3>Proxying cross-origin requests</h3> <p>So far, you could deploy this whole thing on a static server. The issue with prototyping this sort of thing in browser is that most sites won&rsquo;t be fetchable due to security restrictions in browsers. Without <a href='http://en.wikipedia.org/wiki/Cross-origin_resource_sharing' target=_blank>cross-origin requests</a> (CORS) enabled on the server, you can&rsquo;t use <code>$.ajax</code> for content outside of the current domain. I.e., if your site is hosted at http://domain.com, you can&rsquo;t grab data from http://anotherdomain.com.</p> <p>To get around this, we&rsquo;ll just create a proxy server that passes CORS headers and routes requests to the site we&rsquo;re scraping. I&rsquo;m going to go with nodejs for this example, but this is simple enough that it shouldn&rsquo;t take much in any language.</p> <p>This uses express to handle requests and Cacheman to cache responses. Setting up a cache will allow us to serve the data quick while also being good consumers (or at least, <a href='https://danceswithdissonance.files.wordpress.com/2015/01/30-rock-grad-student-are-the-worst.gif' target=_blank>not the <em>worst</em></a>) of others&rsquo; data.</p> <pre class="highlight javascript"><code><span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Cacheman</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'cacheman'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">apiServerHost</span> <span class="o">=</span> <span class="s1">'http://targetdomain.com'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Cacheman</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">disable</span><span class="p">(</span><span class="s1">'quiet'</span><span class="p">);</span>

<span class="c1">// respond to CORS headers from our client app</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s2">"Access-Control-Allow-Origin"</span><span class="p">,</span> <span class="s2">"*"</span><span class="p">);</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s2">"Access-Control-Allow-Headers"</span><span class="p">,</span> <span class="s2">"Origin, X-Requested-With, Content-Type, Accept"</span><span class="p">);</span>
  <span class="nx">next</span><span class="p">();</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// transform the url so that all request go to</span>
  <span class="c1">// the other site. i.e., if our client hits this</span>
  <span class="c1">// proxy server at http://localhost:4000/matches/match_id,</span>
  <span class="c1">// it will return html from http://targeturl.com/matches/match_id</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">apiServerHost</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>

  <span class="c1">// check the cache for the content</span>
  <span class="nx">cache</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="nx">error</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">content</span> <span class="o">===</span> <span class="s1">'undefined'</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// if the content isn't in the cache, request it from the target site.</span>
      <span class="nx">content</span> <span class="o">=</span> <span class="p">[];</span>

      <span class="nx">request</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">response</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">content</span> <span class="o">=</span> <span class="p">{</span> <span class="na">html</span><span class="p">:</span> <span class="nx">body</span> <span class="p">};</span>

        <span class="c1">// add the content to the cache using the url as</span>
        <span class="c1">// the cache key and an expiration of 5 minutes.</span>
        <span class="nx">cache</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">content</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span>
      <span class="p">});</span>
    <span class="p">}</span>

    <span class="c1">// send the content to the client</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">html</span><span class="p">)</span>
  <span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">4000</span><span class="p">);</span>
</code></pre> <p>Now to route our requests through the proxy, we just need to change the url used inside of our <code>$(document).ready()</code> ajax call to <code>localhost:4000</code>.</p> <p>Blam-o. Done. Well, basically. It would also help to style this thing up a bit and actually have an index.html. And you might also want to build some kind of server or integration to pass your fresh, crisp data off to. But that&rsquo;s for another post.</p> </article> <script>
      (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
      function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
      ga('create','UA-58971628-1');ga('send','pageview');
    </script> </body> </html>